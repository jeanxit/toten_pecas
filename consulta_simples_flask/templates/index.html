<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Verificador Simples Nacional</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

   <script>
    function validarCNPJ() {
        var cnpj = document.querySelector("input[name='cnpj']").value;
        var arquivo = document.querySelector("input[name='file']").value;

        if (!cnpj && !arquivo) {
            alert("Por favor, insira um CNPJ ou envie um arquivo Excel.");
            return false;
        }

        if (cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14) {
                alert("CNPJ inválido. Deve conter exatamente 14 dígitos.");
                return false;
            }
            document.querySelector("input[name='cnpj']").value = cnpj;
        }

        return true;
    }

    function exportarExcel() {
        var table = document.getElementById("resultadosTabela");
        var data = [];
        for (var i = 0; i < table.rows.length; i++) {
            var row = table.rows[i];
            var rowData = [];
            for (var j = 0; j < row.cells.length; j++) {
                var valor = row.cells[j].innerText;
                if (j === 0 && i !== 0) {
                    rowData.push({ v: valor, t: "s" });
                } else if (j === 1 && i !== 0) {
                    if (valor === "Sim") {
                        rowData.push("Sim");
                    } else if (valor === "Não") {
                        rowData.push("Não");
                    } else if (valor === "Vazio" || valor === "") {
                        rowData.push("Vazio");
                    } else {
                        rowData.push("Erro ao consultar");
                    }
                } else {
                    rowData.push(valor);
                }
            }
            data.push(rowData);
        }

        var ws = XLSX.utils.aoa_to_sheet(data);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Resultados");
        XLSX.writeFile(wb, "resultado_simples.xlsx");
    }
</script>
</head>
<body>
    <div class="box">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
        <h2>Verificador de Simples Nacional</h2>    
        <form method="POST" enctype="multipart/form-data" onsubmit="return validarCNPJ()">
            <label for="cnpj">Digite um CNPJ:</label><br>
            <input type="text" id="cnpj" name="cnpj" placeholder="Ex: 13919590000100"><br>

            <label for="file">Ou envie um arquivo Excel (.xlsx):</label><br>
            <input type="file" id="file" name="file" accept=".xlsx"><br>

            <button type="submit">Verificar</button>
        </form>

        {% if error %}
            <p style="color:red;">{{ error }}</p>
        {% endif %}

        {% if resultados %}
            <h3>Resultado da Consulta:</h3>
            <table id="resultadosTabela" border="1" cellpadding="5" cellspacing="0">
                <tr><th>CNPJ</th><th>Opção pelo Simples</th></tr>
                {% for item in resultados %}
                    <tr>
                        <td>{{ item.CNPJ }}</td>
                        <td>
                            {% if item.opcao_pelo_simples is not none %}
                                {% if item.opcao_pelo_simples == True %}
                                    Sim
                                {% elif item.opcao_pelo_simples == False %}
                                    Não
                                {% elif item.opcao_pelo_simples == 'null' %}
                                    Vazio
                                {% else %}
                                    Vazio
                                {% endif %}
                            {% else %}
                                Erro ao consultar
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            <button onclick="exportarExcel()">Exportar para Excel</button>
        {% endif %}
    </div>
</body>
</html>
